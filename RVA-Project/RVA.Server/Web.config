<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <configSections>
    <section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler, log4net" />
  </configSections>

  <appSettings>
    <add key="aspnet:UseTaskFriendlySynchronizationContext" value="true" />
    <!-- RVA Application Settings -->
    <add key="DefaultStorageType" value="xml" />
    <add key="DataDirectory" value="DataFiles" />
    <add key="LogDirectory" value="Logs" />
  </appSettings>

  <system.web>
    <compilation debug="true" targetFramework="4.7.2" />
    <httpRuntime targetFramework="4.7.2" maxRequestLength="4096" />
    
    <!-- Session state -->
    <sessionState mode="InProc" timeout="20" />
    
    <!-- Authentication -->
    <authentication mode="None" />
    
    <!-- Authorization -->
    <authorization>
      <allow users="*" />
    </authorization>

    <!-- Custom errors for production -->
    <customErrors mode="RemoteOnly" defaultRedirect="~/Error.htm">
      <error statusCode="404" redirect="~/NotFound.htm" />
      <error statusCode="500" redirect="~/ServerError.htm" />
    </customErrors>
  </system.web>

  <system.serviceModel>
    <!-- Bindings Configuration -->
    <bindings>
      <basicHttpBinding>
        <binding name="DefaultBasicHttpBinding"
                 maxBufferSize="2147483647"
                 maxReceivedMessageSize="2147483647"
                 sendTimeout="00:10:00"
                 receiveTimeout="00:10:00"
                 openTimeout="00:01:00"
                 closeTimeout="00:01:00">
          <readerQuotas maxDepth="2147483647"
                       maxStringContentLength="2147483647"
                       maxArrayLength="2147483647"
                       maxBytesPerRead="2147483647"
                       maxNameTableCharCount="2147483647" />
        </binding>
      </basicHttpBinding>
    </bindings>

    <!-- Services Configuration -->
    <services>
      <service name="RVA.Server.Services.RaftingService" 
               behaviorConfiguration="DefaultServiceBehavior">
        <endpoint address="" 
                  binding="basicHttpBinding" 
                  bindingConfiguration="DefaultBasicHttpBinding"
                  contract="RVA.Server.Interfaces.IRaftingService" />
        <endpoint address="mex"
                  binding="mexHttpBinding"
                  contract="IMetadataExchange" />
      </service>

      <service name="RVA.Server.Services.LocationService"
               behaviorConfiguration="DefaultServiceBehavior">
        <endpoint address="" 
                  binding="basicHttpBinding" 
                  bindingConfiguration="DefaultBasicHttpBinding"
                  contract="RVA.Server.Interfaces.ILocationService" />
        <endpoint address="mex"
                  binding="mexHttpBinding"
                  contract="IMetadataExchange" />
      </service>

      <service name="RVA.Server.Services.ClothingService"
               behaviorConfiguration="DefaultServiceBehavior">
        <endpoint address="" 
                  binding="basicHttpBinding" 
                  bindingConfiguration="DefaultBasicHttpBinding"
                  contract="RVA.Server.Interfaces.IClothingService" />
        <endpoint address="mex"
                  binding="mexHttpBinding"
                  contract="IMetadataExchange" />
      </service>
    </services>

    <!-- Behaviors Configuration -->
    <behaviors>
      <serviceBehaviors>
        <behavior name="DefaultServiceBehavior">
          <!-- Service metadata behavior -->
          <serviceMetadata httpGetEnabled="true" httpsGetEnabled="true" />
          
          <!-- Service debug behavior - set to false for production -->
          <serviceDebug includeExceptionDetailInFaults="true" />
          
          <!-- Service throttling to prevent resource exhaustion -->
          <serviceThrottling 
            maxConcurrentCalls="100"
            maxConcurrentSessions="100"
            maxConcurrentInstances="100" />
        </behavior>
        
        <!-- Default behavior for unnamed services -->
        <behavior>
          <serviceMetadata httpGetEnabled="true" httpsGetEnabled="true" />
          <serviceDebug includeExceptionDetailInFaults="true" />
        </behavior>
      </serviceBehaviors>
    </behaviors>

    <!-- Protocol Mapping -->
    <protocolMapping>
      <add binding="basicHttpsBinding" scheme="https" />
      <add binding="basicHttpBinding" scheme="http" />
    </protocolMapping>    

    <!-- Service Hosting Environment -->
    <serviceHostingEnvironment aspNetCompatibilityEnabled="true" multipleSiteBindingsEnabled="true" />
  </system.serviceModel>

  <system.webServer>
    <modules runAllManagedModulesForAllRequests="true" />
    
    <!-- Directory browsing - set to false for production -->
    <directoryBrowse enabled="true" />
    
    <!-- Default documents -->
    <defaultDocument>
      <files>
        <add value="RaftingService.svc" />
        <add value="LocationService.svc" />
        <add value="ClothingService.svc" />
      </files>
    </defaultDocument>

    <!-- Static content -->
    <staticContent>
      <mimeMap fileExtension=".svc" mimeType="text/plain" />
    </staticContent>

    <!-- HTTP handlers -->
    <handlers>
      <add name="svc-Integrated-4.0" 
           path="*.svc" 
           verb="*" 
           type="System.ServiceModel.Activation.ServiceHttpHandlerFactory, System.ServiceModel.Activation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35" 
           preCondition="integratedMode,runtimeVersionv4.0" />
    </handlers>

    <!-- Validation -->
    <validation validateIntegratedModeConfiguration="false" />
  </system.webServer>

  <runtime>
    <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
      <dependentAssembly>
        <assemblyIdentity name="System.Runtime.CompilerServices.Unsafe" publicKeyToken="b03f5f7f11d50a3a" culture="neutral" />
        <bindingRedirect oldVersion="0.0.0.0-6.0.0.0" newVersion="6.0.0.0" />
      </dependentAssembly>
    </assemblyBinding>
  </runtime>

  <!-- log4net Configuration -->
  <log4net>
    <!-- Rolling File Appender for all logs -->
    <appender name="RollingFileAppender" type="log4net.Appender.RollingFileAppender">
      <file value="Logs\server.log" />
      <appendToFile value="true" />
      <rollingStyle value="Size" />
      <maxSizeRollBackups value="10" />
      <maximumFileSize value="5MB" />
      <staticLogFileName value="true" />
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%date [%thread] %-5level %logger{1} - %message%newline" />
      </layout>
    </appender>

    <!-- Error File Appender - only for errors and fatal -->
    <appender name="ErrorFileAppender" type="log4net.Appender.RollingFileAppender">
      <file value="Logs\errors.log" />
      <appendToFile value="true" />
      <rollingStyle value="Size" />
      <maxSizeRollBackups value="5" />
      <maximumFileSize value="5MB" />
      <staticLogFileName value="true" />
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%date [%thread] %-5level %logger{1} - %message%newline%exception" />
      </layout>
      <filter type="log4net.Filter.LevelRangeFilter">
        <levelMin value="ERROR" />
        <levelMax value="FATAL" />
      </filter>
    </appender>

    <!-- Console Appender for development -->
    <appender name="ConsoleAppender" type="log4net.Appender.ConsoleAppender">
      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%date %-5level - %message%newline" />
      </layout>
    </appender>

    <!-- Root logger -->
    <root>
      <level value="INFO" />
      <appender-ref ref="RollingFileAppender" />
      <appender-ref ref="ErrorFileAppender" />
      <appender-ref ref="ConsoleAppender" />
    </root>

    <!-- Specific loggers for different components -->
    <logger name="RVA.Server.Services" additivity="false">
      <level value="DEBUG" />
      <appender-ref ref="RollingFileAppender" />
      <appender-ref ref="ErrorFileAppender" />
      <appender-ref ref="ConsoleAppender" />
    </logger>

    <logger name="RVA.Server.Data" additivity="false">
      <level value="INFO" />
      <appender-ref ref="RollingFileAppender" />
      <appender-ref ref="ErrorFileAppender" />
    </logger>

    <logger name="RVA.Server.Storage" additivity="false">
      <level value="INFO" />
      <appender-ref ref="RollingFileAppender" />
      <appender-ref ref="ErrorFileAppender" />
    </logger>
  </log4net>
</configuration>